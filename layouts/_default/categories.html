{{ define "main" }}
<div class="universal-wrapper">
    <div class="row">
        <div class="col-lg-12">
            <h1>{{ .Title }}</h1>
            {{ with .Content }}{{ . }}{{ end }}

            <!-- 分类卡片展示 -->
            <div class="row">
                <!-- 方法2: 使用主页面统一配置的权重排序 -->
                {{ $categories := .Site.Taxonomies.categories }}
                {{ $sortedCategories := slice }}

                <!-- 构建分类数据并应用权重 -->
                <!-- 构建分类数据 -->
                {{ range $name, $taxonomy := $categories }}
                {{ $weight := 999 }} <!-- 默认权重 -->

                <!-- 从主页面配置获取权重 -->
                {{ with $.Params.categoryWeights }}
                {{ if index . $name }}
                {{ $weight = index . $name }}
                {{ end }}
                {{ end }}

                <!-- 过滤掉草稿文章，重新统计数量 -->
                {{ $publishedTaxonomy := slice }}
                {{ range $taxonomy }}
                {{ if not .Page.Draft }}
                {{ $publishedTaxonomy = $publishedTaxonomy | append . }}
                {{ end }}
                {{ end }}

                <!-- 只有当分类下有非草稿文章时才显示该分类 -->
                {{ if gt (len $publishedTaxonomy) 0 }}
                {{ $categoryData := dict
                "name" $name
                "taxonomy" $publishedTaxonomy
                "weight" $weight
                "count" (len $publishedTaxonomy)
                }}
                {{ $sortedCategories = $sortedCategories | append $categoryData }}
                {{ end }}
                {{ end }} <!-- 按权重排序（权重越小越靠前） -->
                {{ $sortedCategories = sort $sortedCategories "weight" "asc" }}

                {{ range $sortedCategories }}
                {{ $name := .name }}
                {{ $taxonomy := .taxonomy }}
                {{ $weight := .weight }}
                {{ with $.Site.GetPage (printf "/categories/%s" $name) }}
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card category-card category-{{ $name }} h-100">
                        <div class="card-body d-flex flex-column">
                            <h4 class="card-title">
                                <a href="{{ .Permalink }}" class="text-decoration-none">
                                    <i class="fas fa-folder-open mr-2"></i>{{ .Title }}
                                </a>
                            </h4>
                            <p class="text-muted mb-3">
                                <i class="fas fa-file-alt mr-1"></i>{{ len $taxonomy }} 篇文章
                            </p>

                            <!-- 检查是否有子分类 -->
                            {{ $hasSubcategories := false }}
                            {{ $subcategories := slice }}
                            {{ if eq $name "robot-sim" }}
                            <!-- 收集robot-sim分类下的所有子分类 -->
                            {{ range $taxonomy }}
                            {{ if not .Page.Draft }}
                            {{ range .Page.Params.categories }}
                            {{ if and (ne . "robot-sim") (ne . $name) }}
                            {{ $subcategories = $subcategories | append . }}
                            {{ end }}
                            {{ end }}
                            {{ end }}
                            {{ end }}
                            {{ $subcategories = $subcategories | uniq }}
                            {{ if gt (len $subcategories) 0 }}
                            {{ $hasSubcategories = true }}
                            {{ end }}
                            {{ end }}

                            <!-- 显示子分类或文章列表 -->
                            <div class="category-posts flex-grow-1">
                                {{ if $hasSubcategories }}
                                <!-- 显示子分类 -->
                                <h6 class="text-muted mb-3">子分类：</h6>
                                {{ range $subcategories }}
                                {{ $subcatName := . }}
                                {{ $subcatCount := 0 }}
                                {{ range $taxonomy }}
                                {{ if not .Page.Draft }}
                                {{ if in .Page.Params.categories $subcatName }}
                                {{ $subcatCount = add $subcatCount 1 }}
                                {{ end }}
                                {{ end }}
                                {{ end }}
                                <div class="subcategory-item mb-3">
                                    <a href="{{ $.Site.BaseURL }}category/{{ $subcatName | urlize }}/"
                                        class="subcategory-link d-flex justify-content-between align-items-center">
                                        <span>
                                            <i class="fas fa-tag mr-2"></i>{{ $subcatName }}
                                        </span>
                                        <span class="badge badge-secondary">{{ $subcatCount }}</span>
                                    </a>
                                </div>
                                {{ end }}
                                {{ else }}
                                <!-- 显示文章列表 -->
                                {{ $pages := slice }}
                                {{ range $taxonomy }}
                                <!-- 确保只添加非草稿文章 -->
                                {{ if not .Page.Draft }}
                                {{ $pages = $pages | append .Page }}
                                {{ end }}
                                {{ end }}
                                {{ $sortedPages := sort $pages "Date" "desc" }}
                                {{ range first 5 $sortedPages }}
                                <div class="post-item mb-2">
                                    <a href="{{ .Permalink }}" class="post-link">
                                        {{ .Title }}
                                    </a>
                                    <small class="text-muted d-block">
                                        {{ .Date.Format "2006-01-02" }}
                                    </small>
                                </div>
                                {{ end }}
                                {{ if gt (len $pages) 5 }}
                                <div class="text-muted small">
                                    还有 {{ sub (len $pages) 5 }} 篇文章...
                                </div>
                                {{ end }}
                                {{ end }}
                            </div>
                            <div class="mt-auto pt-3">
                                <a href="{{ .Permalink }}" class="btn btn-outline-primary btn-block">
                                    查看全部文章 <i class="fas fa-arrow-right ml-1"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {{ end }}
                {{ end }}
            </div>
        </div>
    </div>
</div>

<style>
    .category-card {
        transition: transform 0.2s, box-shadow 0.2s;
        border: 1px solid #e9ecef;
    }

    .category-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .category-card .card-title a {
        color: #495057;
    }

    .category-card .card-title a:hover {
        color: #007bff;
    }

    /* 不同分类的颜色配置 */

    /* RL (强化学习) - 蓝色主题 */
    .category-rl {
        border-left: 5px solid #007bff;
        background: linear-gradient(135deg, #f8f9ff 0%, #e3f2fd 100%);
    }

    .category-rl .card-title a {
        color: #0056b3;
    }

    .category-rl:hover {
        box-shadow: 0 4px 20px rgba(0, 123, 255, 0.3);
    }

    /* NLP (自然语言处理) - 绿色主题 */
    .category-nlp {
        border-left: 5px solid #28a745;
        background: linear-gradient(135deg, #f8fff8 0%, #e8f5e8 100%);
    }

    .category-nlp .card-title a {
        color: #1e7e34;
    }

    .category-nlp:hover {
        box-shadow: 0 4px 20px rgba(40, 167, 69, 0.3);
    }

    /* Robot-sim (机器人仿真) - 紫色主题 */
    .category-robot-sim {
        border-left: 5px solid #6f42c1;
        background: linear-gradient(135deg, #faf9ff 0%, #f3f0ff 100%);
    }

    .category-robot-sim .card-title a {
        color: #5a32a3;
    }

    .category-robot-sim:hover {
        box-shadow: 0 4px 20px rgba(111, 66, 193, 0.3);
    }

    /* Tutorials (教程) - 橙色主题 */
    .category-tutorials {
        border-left: 5px solid #fd7e14;
        background: linear-gradient(135deg, #fffcf8 0%, #fff3e0 100%);
    }

    .category-tutorials .card-title a {
        color: #e65100;
    }

    .category-tutorials:hover {
        box-shadow: 0 4px 20px rgba(253, 126, 20, 0.3);
    }

    /* 默认分类 - 灰色主题 */
    .category-card:not(.category-rl):not(.category-nlp):not(.category-robot-sim):not(.category-tutorials) {
        border-left: 5px solid #6c757d;
        background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
    }

    .category-card:not(.category-rl):not(.category-nlp):not(.category-robot-sim):not(.category-tutorials) .card-title a {
        color: #495057;
    }

    .category-card:not(.category-rl):not(.category-nlp):not(.category-robot-sim):not(.category-tutorials):hover {
        box-shadow: 0 4px 20px rgba(108, 117, 125, 0.3);
    }

    .post-link {
        color: #6c757d;
        text-decoration: none;
        font-size: 0.9rem;
    }

    .post-link:hover {
        color: #007bff;
        text-decoration: none;
    }

    .post-item {
        padding: 0.25rem 0;
        border-bottom: 1px solid #f8f9fa;
    }

    .post-item:last-child {
        border-bottom: none;
    }

    /* 子分类样式 */
    .subcategory-item {
        padding: 0.5rem;
        border: 1px solid #e9ecef;
        border-radius: 0.375rem;
        background-color: #f8f9fa;
        transition: all 0.2s;
    }

    .subcategory-item:hover {
        background-color: #e9ecef;
        transform: translateX(2px);
    }

    .subcategory-link {
        text-decoration: none;
        color: #495057;
        font-weight: 500;
    }

    .subcategory-link:hover {
        text-decoration: none;
        color: #007bff;
    }

    .subcategory-item .badge {
        font-size: 0.75rem;
    }
</style>
{{ end }}